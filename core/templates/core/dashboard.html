{% extends 'core/base.html' %}
{% load static %}
{% block title %}Dashboard - Plant Buddy{% endblock %}

{% block content %}

<div class="container">
  <h2>Welcome, {{ user.username }}</h2>

<section class="dashboard-section">
    <div class="summary-card">

      <!-- LEFT: SOIL HEALTH -->
        
<div class="summary-left">
  <h3 class="summary-title">Soil Health Score</h3>

  {% if soil_health %}
    <div class="health-score {{ soil_health.label|lower }}">
      {{ soil_health.score }}
    </div>

    <span class="health-label">
      {{ soil_health.label }} Condition
    </span>

    <p class="updated-time">
      Last updated:
      {{ soil_health_last_updated|default:"Just now" }}
    </p>
  {% else %}
    <p class="no-data">No soil data available yet</p>
  {% endif %}
</div>


      <!-- RIGHT: DEVICE DETAILS -->
      <div class="summary-right">
        <h4>Active Device</h4>

        <form method="get">
          <select name="device" class="device-selector" onchange="this.form.submit()">
            {% for device in devices %}
              <option value="{{ device.id }}"
               {% if active_device and device.id == active_device.id %}selected{% endif %}>
               {{ device.name }}
              </option>
            {% endfor %}
          </select>
        </form>


        {% if active_device %}
          <div class="device-info">
            <p><strong>Name:</strong> {{ active_device.name }}</p>
            <p><strong>Device ID:</strong> {{ active_device.device_id }}</p>
            <p><strong>Location:</strong> {{ active_device.location|default:"—" }}</p>
            <p><strong>Status:</strong> <span class="device-online">Online</span></p>
          </div>
        {% else %}
            <p>No device added yet.</p>
        {% endif %}  

        <!-- Actions -->
        <div class="device-actions">
              {% if active_device %}
                <a href="{% url 'device_data_page' active_device.device_id %}" class="btn-outline small"> View Detailed Analytics → </a>
              {% endif %}

          <button id="toggleDeviceForm" class="btn-primary">+ Add New Device</button>
          <div id="deviceFormContainer" style="display: none; margin-top: 1rem;">
          <form method="post">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="submit" class="btn-primary">Add Device</button>
          </form>
          </div>

        </div>
        </div>
    </div>
  </section>


{% if soil_health %}
<section class="dashboard-section">
  <div class="health-status-grid">

    {% for parameter, status in soil_health.health_report.items %}
      <div class="status-card {{ status }}">
        <span class="param-name">{{ parameter|title }}</span>
        <span class="param-status">{{ status|title }}</span>
      </div>
    {% endfor %}

  </div>
</section>
{% endif %}


<section class="dashboard-section">
  <div class="recommendation-card">
    <h4>Recommended Action</h4>

    {% if soil_health %}
      <p class="recommendation-text">
        Based on current soil condition, corrective actions
        will be shown here.
      </p>
    {% else %}
      <p class="no-data">Recommendations will appear once data is available.</p>
    {% endif %}
  </div>
</section>


</div> 



<script>
  const toggleBtn = document.getElementById('toggleDeviceForm');
  const formContainer = document.getElementById('deviceFormContainer');
  const showLink = document.getElementById('showDeviceForm');
if(toggleBtn){
  toggleBtn.addEventListener('click', () => {
    if (formContainer.style.display === 'none') {
      formContainer.style.display = 'block';
      toggleBtn.textContent = 'Cancel';
    } else {
      formContainer.style.display = 'none';
      toggleBtn.textContent = '+ Add New Device';
    }
  });}
if (showLink) {
  showLink.addEventListener('click', (e) => {
  e.preventDefault();
  formContainer.style.display = 'block';
  if (toggleBtn) toggleBtn.textContent = 'Cancel';
    });
  }
</script>

{% endblock %} 
