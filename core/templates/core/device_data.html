{% extends 'core/base.html' %}

{% block title %}Device Data{% endblock %}

{% block content %}
<h3>Live Sensor Data for {{ device_id }}</h3>
<button id="liveToggle" class="btn-primary">LIVE: OFF</button>

<div class="chart-grid">

  <!-- Nitrogen -->
  <div class="chart-container">
    <div class="npk-values">
      <span>Nitrogen: <strong id="n_value">--</strong></span>
    </div>
    <canvas id="nChart"></canvas>
  </div>

  <!-- Phosphorus -->
  <div class="chart-container">
    <div class="npk-values">
      <span>Phosphorus: <strong id="p_value">--</strong></span>
    </div>
    <canvas id="pChart"></canvas>
  </div>

  <!-- Potassium -->
  <div class="chart-container">
    <div class="npk-values">
      <span>Potassium: <strong id="k_value">--</strong></span>
    </div>
    <canvas id="kChart"></canvas>
  </div>

  <!-- Temperature -->
  <div class="chart-container"><canvas id="TChart"></canvas></div>
  <!-- Humidity -->
  <div class="chart-container"><canvas id="HChart"></canvas></div>
</div>


<style>
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .chart-container {
    width: 98%;
    height: 300px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 10px;
  }
</style>
<style>
  .npk-values {
    text-align: center;
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin-bottom: 6px;
  }

  .npk-values strong {
    color: #2e7d32;
    font-size: 18px;
  }
</style>

<style>
#liveToggle {
  background: #007bff;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  margin-bottom: 15px;
}
#liveToggle.live {
  background: #28a745;
}
</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

  // Custom plugin to draw value text inside doughnut charts
const centerTextPlugin = {
  id: 'centerText',
  afterDraw(chart) {
    if (chart.config.type !== 'doughnut') return;

    const { ctx, chartArea: { width, height } } = chart;
    const dataset = chart.data.datasets[0];
    const value = dataset.data[0];
    const label = chart.config.options.plugins.title.text;

    ctx.save();
    ctx.font = 'bold 18px sans-serif';
    ctx.fillStyle = '#2e7d32';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Draw the value (you can customize font size and Y-offset)
    ctx.fillText(`${value}`, width / 2, height / 1.3);

    ctx.restore();
  }
};

// Register plugin globally
Chart.register(centerTextPlugin);

let charts = {};
const dataStore = {
  timestamps: [],
  nitrogen: [],
  phosphorus: [],
  potassium: [],
  temperature: [],
  humidity: []
};

function chartType(key) {
  return ['nitrogen', 'phosphorus', 'potassium'].includes(key) ? 'line' : 'doughnut';
}

function getColor(key) {
  const colors = {
    nitrogen: 'rgba(255, 99, 132, 1)',
    phosphorus: 'rgba(54, 162, 235, 1)',
    potassium: 'rgba(255, 206, 86, 1)',
    temperature: 'rgba(255, 159, 64, 1)',
    humidity: 'rgba(75, 192, 192, 1)'
  };
  return colors[key];
}

function getUColor(key) {
  const colors = {
    nitrogen: 'rgba(255, 99, 132, 0.2)',
    phosphorus: 'rgba(54, 162, 235, 0.2)',
    potassium: 'rgba(255, 206, 86, 0.2)',
    temperature: 'rgba(255, 159, 64, 0.2)',
    humidity: 'rgba(75, 192, 192, 0.2)'
  };
  return colors[key];
}

function initCharts() {
  const ctxMap = {
    nChart: 'nitrogen',
    pChart: 'phosphorus',
    kChart: 'potassium',
    TChart: 'temperature',
    HChart: 'humidity'
  };

  for (const [id, key] of Object.entries(ctxMap)) {
    const ctx = document.getElementById(id).getContext('2d');
    const type = chartType(key);

    if (type === 'line') {
      charts[key] = new Chart(ctx, {
        type,
        data: {
          labels: dataStore.timestamps,
          datasets: [{
            label: key.charAt(0).toUpperCase() + key.slice(1),
            data: dataStore[key],
            borderColor: getColor(key),
            backgroundColor: getUColor(key),
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Time' } },
            y: { title: { display: true, text: key.toUpperCase() } }
          }
        }
      });
    } 
else if (type === 'doughnut') {
  charts[key] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [key, 'blank'],
      datasets: [{
        label: key,
        data: [0, 100], // [current value, remaining]
        backgroundColor: [getColor(key), '#eee'],
        borderWidth: 0,
        cutout: '70%'
      }]
    },
    options: {
      responsive: true,
      rotation: -90,
      circumference: 180, // half circle
      plugins: {
        legend: { display: false },
        title: { display: true, text: key.toUpperCase() },
        tooltip: {
          filter: (item) => item.dataIndex === 0, // only first slice
          callbacks: {
            label: (context) => {
              const val = context.parsed;
              if (key === 'temperature') return `Temp: ${val} Â°C`;
              if (key === 'humidity') return `Humidity: ${val} %`;
              return `${key}: ${val}`;
            }
          }
        },
        centerText: { } // enables center-text plugin
      },
      interaction: { mode: 'nearest', intersect: true },
      hover: { mode: 'nearest', intersect: true }
    }
  });
}
  }
}

function updateData(newData) {
  const now = new Date().toLocaleTimeString();

  if (dataStore.timestamps.length > 10) {
    for (let key in dataStore) dataStore[key].shift();
  }

  dataStore.timestamps.push(now);
  dataStore.nitrogen.push(newData.nitrogen);
  dataStore.phosphorus.push(newData.phosphorus);
  dataStore.potassium.push(newData.potassium);
  dataStore.temperature.push(newData.temperature);
  dataStore.humidity.push(newData.humidity);
  // Update numerical display
  document.getElementById("n_value").textContent = newData.nitrogen.toFixed(1);
  document.getElementById("p_value").textContent = newData.phosphorus.toFixed(1);
  document.getElementById("k_value").textContent = newData.potassium.toFixed(1);


  // Update charts
  for (let key in charts) {
    const chart = charts[key];

    if (chart.config.type === 'line') {
      chart.update();
    } else if (chart.config.type === 'doughnut') {
      // Update half gauge
      let value = newData[key];
      if (key === 'humidity') value = Math.min(value, 100); // limit
      chart.data.datasets[0].data = [value, 100 - value];
      chart.update();
    }
  }
}

let liveMode = false;
let liveInterval = null;

function fetchLatest() {
  fetch("{% url 'device_latest_json' device_id %}")
    .then(res => res.json())
    .then(data => {
      if (data.nitrogen !== undefined) {
        updateData(data);
      }
    });
}

function fetchHistory() {
  fetch("{% url 'device_history_json' device_id %}")
    .then(res => res.json())
    .then(data => {
      const history = data.history;
      dataStore.timestamps = [];
      dataStore.nitrogen = [];
      dataStore.phosphorus = [];
      dataStore.potassium = [];
      dataStore.temperature = [];
      dataStore.humidity = [];

      history.forEach(entry => {
        dataStore.timestamps.push(entry.timestamp);
        dataStore.nitrogen.push(entry.nitrogen);
        dataStore.phosphorus.push(entry.phosphorus);
        dataStore.potassium.push(entry.potassium);
        dataStore.temperature.push(entry.temperature);
        dataStore.humidity.push(entry.humidity);
      });

      // Update text values using last entry
      const last = history[history.length - 1];
      updateData(last, false); // update charts without pushing new timestamps

      for (let key in charts) charts[key].update();
    });
}

function updateData(newData, pushTime = true) {
  const now = new Date().toLocaleTimeString();

  if (pushTime) {
    if (dataStore.timestamps.length > 10) {
      for (let key in dataStore) dataStore[key].shift();
    }
    dataStore.timestamps.push(now);
    dataStore.nitrogen.push(newData.nitrogen);
    dataStore.phosphorus.push(newData.phosphorus);
    dataStore.potassium.push(newData.potassium);
    dataStore.temperature.push(newData.temperature);
    dataStore.humidity.push(newData.humidity);
  }

  document.getElementById("n_value").textContent = newData.nitrogen;
  document.getElementById("p_value").textContent = newData.phosphorus;
  document.getElementById("k_value").textContent = newData.potassium;

  for (let key in charts) {
    let chart = charts[key];

    if (chart.config.type === "line") {
      chart.update();
    } else {
      let value = newData[key];
      chart.data.datasets[0].data = [value, 100 - value];
      chart.update();
    }
  }
}

document.getElementById("liveToggle").addEventListener("click", () => {
  liveMode = !liveMode;

  const btn = document.getElementById("liveToggle");
  btn.textContent = liveMode ? "LIVE: ON" : "LIVE: OFF";
  btn.classList.toggle("live", liveMode);

  if (liveMode) {
    // start live mode
    liveInterval = setInterval(fetchLatest, 10000);
    fetchLatest();  // fetch immediately
  } else {
    // stop live mode
    clearInterval(liveInterval);
    fetchHistory();
  }
});


initCharts();
fetchHistory();

</script>

<br>
<a href="{% url 'dashboard' %}" class="btn-primary">Back to Dashboard</a>

{% endblock %}