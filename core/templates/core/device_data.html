{% extends 'core/base.html' %}

{% block title %}Device Data{% endblock %}

{% block content %}
<h3>Sensor Data for {{ device_id }}</h3>

<button id="liveToggle" class="btn-primary">LIVE: OFF</button>

<div class="chart-grid">

  <!-- Nitrogen -->
  <div class="chart-container">
    <div class="npk-values">
      <span>Nitrogen: <strong id="n_value">--</strong></span>
    </div>
    <canvas id="nChart"></canvas>
  </div>

  <!-- Phosphorus -->
  <div class="chart-container">
    <div class="npk-values">
      <span>Phosphorus: <strong id="p_value">--</strong></span>
    </div>
    <canvas id="pChart"></canvas>
  </div>

  <!-- Potassium -->
  <div class="chart-container">
    <div class="npk-values">
      <span>Potassium: <strong id="k_value">--</strong></span>
    </div>
    <canvas id="kChart"></canvas>
  </div>

  <!-- Temperature -->
  <div class="chart-container"><canvas id="TChart"></canvas></div>

  <!-- Humidity -->
  <div class="chart-container"><canvas id="HChart"></canvas></div>

</div>

<style>
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .chart-container {
    width: 98%;
    height: 300px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 10px;
  }

  .npk-values {
    text-align: center;
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin-bottom: 6px;
  }

  .npk-values strong {
    color: #2e7d32;
    font-size: 18px;
  }

  #liveToggle {
    background: #007bff;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    margin-bottom: 15px;
  }
  #liveToggle.live {
    background: #28a745;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

// ---------------------------
// Doughnut Center Text Plugin
// ---------------------------
const centerTextPlugin = {
  id: 'centerText',
  afterDraw(chart) {
    if (chart.config.type !== 'doughnut') return;

    const { ctx, chartArea: { width, height } } = chart;
    const value = chart.data.datasets[0].data[0];

    ctx.save();
    ctx.font = 'bold 18px sans-serif';
    ctx.fillStyle = '#2e7d32';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${value}`, width / 2, height / 1.3);
    ctx.restore();
  }
};

Chart.register(centerTextPlugin);

// ---------------------------
// Chart Data Store
// ---------------------------
let charts = {};
let liveMode = false;

const dataStore = {
  timestamps: [],
  nitrogen: [],
  phosphorus: [],
  potassium: [],
  temperature: [],
  humidity: []
};

// ---------------------------
// Chart Initialization
// ---------------------------
function chartType(key) {
  return ['nitrogen', 'phosphorus', 'potassium'].includes(key)
    ? 'line'
    : 'doughnut';
}

function getColor(key) {
  const colors = {
    nitrogen: 'rgba(255, 99, 132, 1)',
    phosphorus: 'rgba(54, 162, 235, 1)',
    potassium: 'rgba(255, 206, 86, 1)',
    temperature: 'rgba(255, 159, 64, 1)',
    humidity: 'rgba(75, 192, 192, 1)'
  };
  return colors[key];
}

function getUColor(key) {
  const colors = {
    nitrogen: 'rgba(255, 99, 132, 0.2)',
    phosphorus: 'rgba(54, 162, 235, 0.2)',
    potassium: 'rgba(255, 206, 86, 0.2)',
    temperature: 'rgba(255, 159, 64, 0.2)',
    humidity: 'rgba(75, 192, 192, 0.2)'
  };
  return colors[key];
}

function initCharts() {
  const chartMap = {
    nChart: 'nitrogen',
    pChart: 'phosphorus',
    kChart: 'potassium',
    TChart: 'temperature',
    HChart: 'humidity'
  };

  for (const [canvasId, key] of Object.entries(chartMap)) {
    const ctx = document.getElementById(canvasId).getContext('2d');

    if (chartType(key) === 'line') {
      charts[key] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dataStore.timestamps,
          datasets: [{
            label: key.charAt(0).toUpperCase() + key.slice(1),
            data: dataStore[key],
            borderColor: getColor(key),
            backgroundColor: getUColor(key),
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
        }
      });

    } else {
      charts[key] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [key, ''],
          datasets: [{
            data: [0, 100],
            backgroundColor: [getColor(key), '#eee'],
            borderWidth: 0,
            cutout: '70%'
          }]
        },
        options: {
          responsive: true,
          rotation: -90,
          circumference: 180,
          plugins: {
            legend: { display: false },
            title: { display: true, text: key.toUpperCase() },
            centerText: {}
          }
        }
      });
    }
  }
}

// ---------------------------
// History Mode (LOAD 10 ENTRIES)
// ---------------------------
function loadHistory() {
  fetch("{% url 'device_history_json' device_id %}")
    .then(res => res.json())
    .then(data => {
      const history = data.history;

      // Reset arrays
      for (let key in dataStore) dataStore[key] = [];

      // Load history data
      history.forEach(entry => {
        dataStore.timestamps.push(entry.timestamp);
        dataStore.nitrogen.push(entry.nitrogen);
        dataStore.phosphorus.push(entry.phosphorus);
        dataStore.potassium.push(entry.potassium);
        dataStore.temperature.push(entry.temperature);
        dataStore.humidity.push(entry.humidity);
      });

      const last = history[history.length - 1];

      // Update Text
      document.getElementById("n_value").textContent = last.nitrogen;
      document.getElementById("p_value").textContent = last.phosphorus;
      document.getElementById("k_value").textContent = last.potassium;

      // Update charts
      for (let key in charts) {
        if (charts[key].config.type === "line") {
          charts[key].data.labels = dataStore.timestamps;
          charts[key].data.datasets[0].data = dataStore[key];
        } else {
          charts[key].data.datasets[0].data = [
            last[key],
            100 - last[key]
          ];
        }
        charts[key].update();
      }
    });
}

// ---------------------------
// LIVE WebSocket Mode
// ---------------------------
const socket = new WebSocket(
  "wss://" + window.location.host + "/ws/device/{{ device_id }}/"
);

socket.onmessage = (e) => {
  if (!liveMode) return;

  const data = JSON.parse(e.data);
  updateLiveData(data);
};

function updateLiveData(newData) {
  const now = new Date().toLocaleTimeString();

  if (dataStore.timestamps.length > 10) {
    for (let key in dataStore) dataStore[key].shift();
  }

  dataStore.timestamps.push(now);
  dataStore.nitrogen.push(newData.nitrogen);
  dataStore.phosphorus.push(newData.phosphorus);
  dataStore.potassium.push(newData.potassium);
  dataStore.temperature.push(newData.temperature);
  dataStore.humidity.push(newData.humidity);

  document.getElementById("n_value").textContent = newData.nitrogen;
  document.getElementById("p_value").textContent = newData.phosphorus;
  document.getElementById("k_value").textContent = newData.potassium;

  for (let key in charts) {
    if (charts[key].config.type === 'line') {
      charts[key].update();
    } else {
      charts[key].data.datasets[0].data = [
        newData[key],
        100 - newData[key]
      ];
      charts[key].update();
    }
  }
}

// ---------------------------
// LIVE Toggle Button
// ---------------------------
document.getElementById("liveToggle").onclick = () => {
  liveMode = !liveMode;

  const btn = document.getElementById("liveToggle");
  btn.textContent = liveMode ? "LIVE: ON" : "LIVE: OFF";
  btn.classList.toggle("live", liveMode);

  if (!liveMode) loadHistory();
};

initCharts();
loadHistory();

</script>

<br>
<a href="{% url 'dashboard' %}" class="btn-primary">Back to Dashboard</a>

{% endblock %}
